<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - The ACJ Portfolio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/assets/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard">
                            <i class="fas fa-chart-bar me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/blog-posts">
                            <i class="fas fa-blog me-1"></i>Blog Posts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/work-items">
                            <i class="fas fa-briefcase me-1"></i>Work Items
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/contacts">
                            <i class="fas fa-envelope me-1"></i>Contacts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/categories">
                            <i class="fas fa-tags me-1"></i>Categories
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/content">
                            <i class="fas fa-edit me-1"></i>Content
                        </a>
                    </li>
                    <li class="nav-item" id="usersNav" style="display: none;">
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users me-1"></i>Users
                        </a>
                    </li>
                    <li class="nav-item" id="settingsNav" style="display: none;">
                        <a class="nav-link" href="/admin/settings">
                            <i class="fas fa-cog me-1"></i>Settings
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-shield me-1"></i><span id="adminName">Admin</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                                <i class="fas fa-user me-2"></i>Profile
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <i class="fas fa-key me-2"></i>Change Password
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Welcome Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </h4>
                        <p class="card-text">Welcome back, <span id="welcomeAdminName">Admin</span>!</p>
                        <small id="lastLogin">Last login: Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="statsCards">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total Users
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Blog Posts
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBlogPosts">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-blog fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Work Items
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalWorkItems">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-briefcase fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Unread Contacts
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="unreadContacts">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-envelope fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Recent Activity -->
        <div class="row">
            <!-- Monthly Activity Chart -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-line me-2"></i>Monthly Activity
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-clock me-2"></i>Recent Activity
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <a href="/admin/blog-posts?action=create" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-plus me-2"></i>New Blog Post
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/admin/work-items?action=create" class="btn btn-outline-success w-100">
                                    <i class="fas fa-plus me-2"></i>New Work Item
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/admin/categories?action=create" class="btn btn-outline-info w-100">
                                    <i class="fas fa-plus me-2"></i>New Category
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/admin/contacts" class="btn btn-outline-warning w-100">
                                    <i class="fas fa-envelope me-2"></i>View Contacts
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/admin/content" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-edit me-2"></i>Edit Content
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="profileUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="profileEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="profileFullName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <input type="text" class="form-control" id="profileRole" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateProfileBtn">Update Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/assets/admin.js"></script>
    <script>
        // Dashboard specific functionality
        class Dashboard {
            constructor() {
                this.init();
            }

            async init() {
                console.log('Dashboard: Initializing...');
                await this.checkAuth();
                this.setupEventListeners();
                await this.loadDashboardData();
            }

            async checkAuth() {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }

                // Verify token
                try {
                    const response = await fetch('/api/admin/auth/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (!result.success) {
                        this.handleAuthError();
                        return;
                    }

                    this.admin = result.data.admin;
                    this.updateUI();
                } catch (error) {
                    this.handleAuthError();
                }
            }

            handleAuthError() {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminRefreshToken');
                window.location.href = 'login.html';
            }

            updateUI() {
                document.getElementById('adminName').textContent = this.admin.fullName || this.admin.username;
                document.getElementById('welcomeAdminName').textContent = this.admin.fullName || this.admin.username;

                // Show/hide navigation items based on role
                if (this.admin.role === 'super_admin') {
                    document.getElementById('usersNav').style.display = 'block';
                    document.getElementById('settingsNav').style.display = 'block';
                }

                // Update profile modal
                document.getElementById('profileUsername').value = this.admin.username;
                document.getElementById('profileEmail').value = this.admin.email;
                document.getElementById('profileFullName').value = this.admin.fullName;
                document.getElementById('profileRole').value = this.admin.role;

                // Show last login if available
                if (this.admin.lastLogin) {
                    const lastLogin = new Date(this.admin.lastLogin).toLocaleString();
                    document.getElementById('lastLogin').textContent = `Last login: ${lastLogin}`;
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });

                document.getElementById('updateProfileBtn').addEventListener('click', () => {
                    this.updateProfile();
                });

                document.getElementById('changePasswordBtn').addEventListener('click', () => {
                    this.changePassword();
                });
            }

            async loadDashboardData() {
                try {
                    const token = localStorage.getItem('adminToken');
                    console.log('Loading dashboard data, token exists:', !!token);
                    
                    if (!token) {
                        console.error('No admin token found');
                        return;
                    }
                    
                    const response = await fetch('/api/admin/dashboard/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    console.log('Dashboard API response status:', response.status);
                    const result = await response.json();
                    console.log('Dashboard API result:', result);

                    if (result.success) {
                        console.log('Updating stats cards with data:', result.data);
                        this.updateStatsCards(result.data);
                        this.updateRecentActivity(result.data.recent);
                        this.updateMonthlyChart(result.data.monthly);
                    } else {
                        console.error('Dashboard API failed:', result.error);
                    }
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }

            updateStatsCards(data) {
                console.log('Updating stats cards with:', data);
                document.getElementById('totalUsers').textContent = data.total.users;
                document.getElementById('totalBlogPosts').textContent = data.total.blogPosts;
                document.getElementById('totalWorkItems').textContent = data.total.workItems;
                document.getElementById('unreadContacts').textContent = data.active.unreadContacts;
                
                console.log('Stats updated - Users:', data.total.users, 'Posts:', data.total.blogPosts);
            }

            updateRecentActivity(recentData) {
                const container = document.getElementById('recentActivity');
                
                if (recentData.blogPosts.length === 0 && recentData.contacts.length === 0) {
                    container.innerHTML = '<p class="text-muted">No recent activity</p>';
                    return;
                }

                let html = '';
                
                recentData.blogPosts.forEach(post => {
                    html += `
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <div class="icon-circle bg-primary">
                                    <i class="fas fa-blog text-white"></i>
                                </div>
                            </div>
                            <div>
                                <div class="small text-gray-500">${new Date(post.createdAt).toLocaleDateString()}</div>
                                <strong>New blog post: ${post.title}</strong>
                            </div>
                        </div>
                    `;
                });

                recentData.contacts.forEach(contact => {
                    html += `
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <div class="icon-circle ${contact.isRead ? 'bg-success' : 'bg-warning'}">
                                    <i class="fas fa-envelope text-white"></i>
                                </div>
                            </div>
                            <div>
                                <div class="small text-gray-500">${new Date(contact.createdAt).toLocaleDateString()}</div>
                                <strong>${contact.name} - ${contact.subject}</strong>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            updateMonthlyChart(monthlyData) {
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['This Month'],
                        datasets: [{
                            label: 'Blog Posts',
                            data: [monthlyData.posts],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }, {
                            label: 'Contacts',
                            data: [monthlyData.contacts],
                            borderColor: 'rgb(255, 205, 86)',
                            backgroundColor: 'rgba(255, 205, 86, 0.2)',
                            tension: 0.1
                        }, {
                            label: 'New Users',
                            data: [monthlyData.users],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            async logout() {
                try {
                    const token = localStorage.getItem('adminToken');
                    await fetch('/api/admin/auth/logout', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                } finally {
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminRefreshToken');
                    window.location.href = 'login.html';
                }
            }

            async updateProfile() {
                const formData = {
                    email: document.getElementById('profileEmail').value,
                    fullName: document.getElementById('profileFullName').value
                };

                try {
                    const token = localStorage.getItem('adminToken');
                    const response = await fetch('/api/admin/auth/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showAlert('Profile updated successfully!', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                        this.admin = result.data.admin;
                        this.updateUI();
                    } else {
                        this.showAlert(result.error || 'Failed to update profile', 'danger');
                    }
                } catch (error) {
                    this.showAlert('An error occurred while updating profile', 'danger');
                }
            }

            async changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;

                if (newPassword !== confirmPassword) {
                    this.showAlert('New passwords do not match', 'danger');
                    return;
                }

                try {
                    const token = localStorage.getItem('adminToken');
                    const response = await fetch('/api/admin/auth/change-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            currentPassword,
                            newPassword
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showAlert('Password changed successfully!', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                        document.getElementById('changePasswordForm').reset();
                    } else {
                        this.showAlert(result.error || 'Failed to change password', 'danger');
                    }
                } catch (error) {
                    this.showAlert('An error occurred while changing password', 'danger');
                }
            }

            showAlert(message, type) {
                const alertContainer = document.getElementById('alertContainer') || this.createAlertContainer();
                alertContainer.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }

            createAlertContainer() {
                const container = document.createElement('div');
                container.id = 'alertContainer';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
                return container;
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new Dashboard();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Debug Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Admin Dashboard Debug Test</h1>
        
        <div class="card mb-4">
            <div class="card-header">Debug Results</div>
            <div class="card-body" id="debugResults">
                <div class="text-muted">Running tests...</div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Current Token</div>
            <div class="card-body">
                <div id="tokenStatus"></div>
                <button class="btn btn-sm btn-primary" onclick="testLogin()">Test Login</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">API Test Results</div>
            <div class="card-body" id="apiResults">
                <div class="text-muted">No tests run yet</div>
            </div>
        </div>
    </div>

    <script>
        let debugResults = document.getElementById('debugResults');
        let apiResults = document.getElementById('apiResults');
        let tokenStatus = document.getElementById('tokenStatus');

        function addDebugMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const classMap = {
                'info': 'text-info',
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning'
            };
            
            debugResults.innerHTML += `
                <div class="${classMap[type] || 'text-info'}">
                    [${timestamp}] ${message}
                </div>
            `;
        }

        function addApiResult(result) {
            apiResults.innerHTML = `
                <div class="alert alert-info">
                    <strong>API Response:</strong><br>
                    <pre style="white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        function updateTokenStatus() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                tokenStatus.innerHTML = `
                    <div class="text-success">
                        <strong>Token Found:</strong><br>
                        Length: ${token.length}<br>
                        Starts with: ${token.substring(0, 20)}...
                    </div>
                `;
            } else {
                tokenStatus.innerHTML = `
                    <div class="text-danger">
                        <strong>No Token Found</strong>
                    </div>
                `;
            }
        }

        async function testLogin() {
            addDebugMessage('Testing login...', 'info');
            
            try {
                const response = await fetch('/api/admin/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const result = await response.json();
                addApiResult(result);
                
                if (result.success && result.data.token) {
                    localStorage.setItem('adminToken', result.data.token);
                    addDebugMessage('Login successful, token stored', 'success');
                    updateTokenStatus();
                } else {
                    addDebugMessage('Login failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                addDebugMessage('Login error: ' + error.message, 'error');
            }
        }

        async function testDashboardAPI() {
            addDebugMessage('Testing dashboard API...', 'info');
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                addDebugMessage('No token found, please login first', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/dashboard/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                addApiResult(result);
                
                if (result.success) {
                    const data = result.data;
                    addDebugMessage('Dashboard API successful!', 'success');
                    addDebugMessage(`Total Users: ${data.total.users}`, 'info');
                    addDebugMessage(`Blog Posts: ${data.total.blogPosts}`, 'info');
                    addDebugMessage(`Work Items: ${data.total.workItems}`, 'info');
                    addDebugMessage(`Categories: ${data.total.categories}`, 'info');
                } else {
                    addDebugMessage('Dashboard API failed: ' + result.error, 'error');
                }
            } catch (error) {
                addDebugMessage('Dashboard API error: ' + error.message, 'error');
            }
        }

        async function testAuthAPI() {
            addDebugMessage('Testing auth/me API...', 'info');
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                addDebugMessage('No token found, please login first', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                addApiResult(result);
                
                if (result.success) {
                    addDebugMessage('Auth API successful!', 'success');
                    addDebugMessage(`Admin: ${result.data.admin.username}`, 'info');
                    addDebugMessage(`Role: ${result.data.admin.role}`, 'info');
                } else {
                    addDebugMessage('Auth API failed: ' + result.error, 'error');
                }
            } catch (error) {
                addDebugMessage('Auth API error: ' + error.message, 'error');
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            addDebugMessage('Page loaded, starting tests...', 'info');
            updateTokenStatus();
            
            // Check if token exists
            const token = localStorage.getItem('adminToken');
            if (token) {
                addDebugMessage('Token found in localStorage', 'success');
                testAuthAPI();
                testDashboardAPI();
            } else {
                addDebugMessage('No token found in localStorage', 'warning');
            }
        });
    </script>
</body>
</html>